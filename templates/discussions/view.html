{% extends "base.html" %}

{% block title %}{{ discussion.title }}{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row justify-content-center">
        <div class="col-xl-8">
            <!-- Discussion Header -->
            <div class="card border-0 shadow-sm mb-3">
                <div class="card-header bg-primary text-white border-0 py-2">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">{{ discussion.title }}</h5>
                        <a href="{{ url_for('discussions') }}" class="btn btn-light btn-sm">
                            <i class="fas fa-arrow-left"></i>
                        </a>
                    </div>
                </div>
                <div class="card-body p-3">
                    <small class="text-muted">by {{ discussion.user.username }} â€¢ {{ discussion.date.strftime('%b %d, %Y') }}</small>
                    <p class="mb-0 mt-2">{{ discussion.content }}</p>
                </div>
            </div>
            
            <!-- Chat Interface -->
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-0">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-comments me-2 text-primary"></i>Live Discussion</h5>
                        <span class="badge bg-primary rounded-pill">{{ messages|length }} messages</span>
                    </div>
                </div>
                <div class="card-body p-0">
                    <!-- Chat Messages Container -->
                    <div id="chat-container" class="chat-container">
                        {% if messages %}
                            {% for message in messages %}
                            <div class="message-wrapper {% if message.user_id == current_user.id %}own-message{% endif %}">
                                <div class="message-bubble {% if message.user_id == current_user.id %}own-bubble{% else %}other-bubble{% endif %}">
                                    <div class="message-header">
                                        <span class="username">{{ message.user.username }}</span>
                                        <span class="timestamp">{{ message.timestamp.strftime('%I:%M %p') }}</span>
                                    </div>
                                    <div class="message-content">{{ message.content }}</div>
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="empty-chat">
                                <i class="fas fa-comment-dots fa-4x text-muted mb-3"></i>
                                <h5 class="text-muted">No messages yet</h5>
                                <p class="text-muted">Be the first to share your thoughts!</p>
                            </div>
                        {% endif %}
                    </div>
                    
                    <!-- Message Input -->
                    <div class="message-input-container">
                        <form method="POST" action="{{ url_for('add_message', discussion_id=discussion.id) }}" class="message-form">
                            <div class="input-group">
                                <input type="text" name="content" class="form-control message-input" 
                                       placeholder="Type your message..." required>
                                <button type="submit" class="btn btn-primary send-btn">
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.bg-gradient-primary {
    background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
}

.avatar-circle {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2rem;
}

.chat-container {
    height: 250px;
    overflow-y: auto;
    padding: 0.75rem;
    background: #f8f9fa;
    border-bottom: 1px solid #dee2e6;
}

.message-wrapper {
    margin-bottom: 0.75rem;
    display: flex;
}

.message-wrapper.own-message {
    justify-content: flex-end;
}

.message-bubble {
    max-width: 65%;
    padding: 0.5rem 0.75rem;
    border-radius: 1rem;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    font-size: 0.9rem;
}

.own-bubble {
    background: linear-gradient(135deg, #007bff, #0056b3);
    color: white;
    border-bottom-right-radius: 0.25rem;
}

.other-bubble {
    background: white;
    color: #333;
    border: 1px solid #e9ecef;
    border-bottom-left-radius: 0.25rem;
}

.message-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.25rem;
    font-size: 0.75rem;
}

.own-bubble .message-header {
    color: rgba(255,255,255,0.8);
}

.other-bubble .message-header {
    color: #6c757d;
}

.username {
    font-weight: 600;
}

.message-content {
    font-size: 0.9rem;
    line-height: 1.4;
}

.message-input-container {
    padding: 1rem;
    background: white;
}

.message-input {
    border: 2px solid #e9ecef;
    border-radius: 2rem;
    padding: 0.75rem 1rem;
    font-size: 0.9rem;
}

.message-input:focus {
    border-color: #007bff;
    box-shadow: 0 0 0 0.2rem rgba(0,123,255,0.25);
}

.send-btn {
    border-radius: 50%;
    width: 45px;
    height: 45px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.empty-chat {
    text-align: center;
    padding: 3rem 1rem;
}

/* Scrollbar styling */
.chat-container::-webkit-scrollbar {
    width: 6px;
}

.chat-container::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 3px;
}

.chat-container::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 3px;
}

.chat-container::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}
</style>

<script>
let lastMessageId = 0;

// Auto-scroll to bottom of chat
function scrollToBottom() {
    const chatContainer = document.getElementById('chat-container');
    chatContainer.scrollTop = chatContainer.scrollHeight;
}

// Load messages with new styling
function loadMessages() {
    fetch('{{ url_for("get_messages", discussion_id=discussion.id) }}')
        .then(response => response.json())
        .then(data => {
            const chatContainer = document.getElementById('chat-container');
            const messages = data.messages;
            
            if (messages.length > 0 && messages[messages.length - 1].id > lastMessageId) {
                let html = '';
                
                if (messages.length === 0) {
                    html = `<div class="empty-chat">
                        <i class="fas fa-comment-dots fa-4x text-muted mb-3"></i>
                        <h5 class="text-muted">No messages yet</h5>
                        <p class="text-muted">Be the first to share your thoughts!</p>
                    </div>`;
                } else {
                    messages.forEach(message => {
                        const wrapperClass = message.is_current_user ? 'message-wrapper own-message' : 'message-wrapper';
                        const bubbleClass = message.is_current_user ? 'message-bubble own-bubble' : 'message-bubble other-bubble';
                        
                        html += `<div class="${wrapperClass}">
                            <div class="${bubbleClass}">
                                <div class="message-header">
                                    <span class="username">${message.username}</span>
                                    <span class="timestamp">${message.timestamp}</span>
                                </div>
                                <div class="message-content">${message.content}</div>
                            </div>
                        </div>`;
                    });
                }
                
                chatContainer.innerHTML = html;
                lastMessageId = messages.length > 0 ? messages[messages.length - 1].id : 0;
                scrollToBottom();
            }
        })
        .catch(error => console.error('Error loading messages:', error));
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    scrollToBottom();
    loadMessages();
    
    // Refresh messages every 3 seconds
    setInterval(loadMessages, 3000);
    
    // Auto-submit form on Enter key
    const messageInput = document.querySelector('.message-input');
    messageInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            this.closest('form').submit();
        }
    });
    
    // Focus on input when page loads
    messageInput.focus();
});
</script>
{% endblock %}